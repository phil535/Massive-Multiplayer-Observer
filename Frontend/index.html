<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Massive Multiplayer Observer!</title>
        <script src="js/phaser.min.js"></script>
        <script src="js/jquery.min.js"></script>
    </head>
    <body>
    <script type="text/javascript">

        var game = undefined;
        var gameData = undefined;

        window.onload = function() {

            var connection = new WebSocket('ws://localhost:8888');

            function getPlayerById(id){
                for(var index = 0; index < gameData.players.length; ++index){
                    if(gameData.players[index].id == id)
                        return gameData.players[index];
                }
                return undefined;
            }

            connection.onmessage = function (e) {
                if(game == undefined){
                    gameData = JSON.parse(e.data);
                    game = new Phaser.Game(gameData.boardwidth, gameData.boardheight, Phaser.AUTO, '', {create: createPlayer});

                    function createPlayer(){
                        for(var index = 0; index < gameData.players.length; ++index){
                            var player = gameData.players[index];
                            player.sprite = game.add.graphics(player.x, player.y);
                            player.sprite.beginFill(0xFFFF0B, 0.5);
                            player.sprite.drawCircle(0, 0, 50);
                            console.log('[' + player.id + '] pos(' + player.x + ',' + player.y + ')');
                        }
                    }
                }else{
                    msg = JSON.parse(e.data);

                    for(var index = 0; index < msg.players.length; ++index){
                        var player = getPlayerById(msg.players[index].id);

                        // player found
                        if(player != undefined){
                            // update position
                            player.x = msg.players[index].x;
                            player.y = msg.players[index].y;
                            player.sprite.position.x = player.x;
                            player.sprite.position.y = player.y;

                        }else{
                            player = {'id': msg.players[index].id, 'x': msg.players[index].x, 'y': msg.players[index].y, 'sprite': undefined};
                            // add new player
                            player.sprite = game.add.graphics(player.x, player.y);
                            player.sprite.beginFill(0xFFFF0B, 0.5);
                            player.sprite.drawCircle(0, 0, 50);
                            gameData.players.push(player);
                        }
                    }
                }
            };
        };

    </script>

    </body>
</html>