<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Massive Multiplayer Observer!</title>
        <script src="js/phaser.min.js"></script>
        <script src="js/jquery.min.js"></script>
    </head>
    <body>
    <script type="text/javascript">

        // globals
        var game = undefined;
        var players = [];
        var WEBSOCKET_SERVER_LOCATION = 'ws://localhost:8888';

        function getPlayerById(id){
            for(var index = 0; index < players.length; ++index){
                if(players[index].id == id)
                    return players[index];
            }
            return undefined;
        }
        function updatePlayer(id, x, y){
            if(game == undefined) return undefined;
            var player = getPlayerById(id);
            if(player == undefined) {
                player = {'id': id, 'sprite': game.add.graphics(x, y)};
                player.sprite.beginFill(0xFFFF0B, 0.5);
                player.sprite.drawCircle(0, 0, 50);
                players.push(player);
            }else{
                player.sprite.position.x = x;
                player.sprite.position.y = y;
            }
        }
        function parseMessage(msg){
            if(msg == undefined || msg.players == undefined) return undefined;
            for(var index = 0; index < msg.players.length; ++index) {
                if(msg.players[index].id == undefined || msg.players[index].x == undefined || msg.players[index].y == undefined)
                    return undefined;
                updatePlayer(msg.players[index].id, msg.players[index].x, msg.players[index].y);
            }
        }
        function removeAllPlayers(){
            if(game == undefined) return undefined;
            for(var index = 0; index < players.length; ++index){
                players[index].sprite.destroy();
            }
            players = [];
        }
        $(document).ready(function(){
            game = new Phaser.Game(800, 800, Phaser.AUTO, 'Massive Multiplayer Observer!', {create: initWebsocket});
        });
        function initWebsocket(){
            var connection = new WebSocket(WEBSOCKET_SERVER_LOCATION);

            connection.onmessage = function(event) {
                parseMessage(JSON.parse(event.data));
            };
            connection.onclose = function(){
                removeAllPlayers();
                setTimeout(function(){initWebsocket()}, 3000);
            };
        }
    </script>
    </body>
</html>