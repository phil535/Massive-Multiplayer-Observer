<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Massive Multiplayer Observer!</title>
        <script src="js/phaser.min.js"></script>
        <script src="js/jquery.min.js"></script>
        <style>
            body{background: #000000;  margin: 0; padding: 0; width:100%}
            h1{color: lawngreen;  text-align: center;}
            canvas{margin: auto; border: 2px solid lawngreen;}
        </style>
    </head>
    <body>
    <h1>Massive Multiplayer Observer</h1>
    <script type="text/javascript">
        // globals
        var game = undefined;
        var players = [];
        var x;
        var WEBSOCKET_SERVER_LOCATION = 'ws://localhost:8888';
        var PLAYER_RANGE = 100;

        function getPlayerById(id){
            for(var it = 0; it < players.length; it++){
                if(players[it].id == id)
                    return players[it];
            }
            return undefined;
        }
        function randomColor(){
            var rgb = [Math.random() * 106 + 150, Math.random() * 106 + 150, Math.random() * 106 + 150];
            return rgb[2] + rgb[1] * 256 + rgb[0] * 65536;
        }
        function getPlayerObserverText(observers){
            if(observers == undefined)
                return "";
            console.log(observers);
            var observers_text = "[";
            for(var it = 0; it < observers.length; it++){
                if(it != 0) observers_text += ',';
                observers_text += observers[it];
            }
            observers_text += ']';
            return observers_text;
        }

        function createPlayerSprite(player, observers){
            if(game == undefined) return undefined;
            var sprite = game.add.group();

            circle = game.add.graphics(10, 10);
            var color = randomColor();
            circle.beginFill(color, 0.2);
            circle.drawCircle(0, 0, PLAYER_RANGE * 2);
            circle.endFill();
            circle.beginFill(color, 1);
            circle.drawCircle(0, 0, 4);
            circle.endFill();
            circle.lineStyle(1, color, 0.5);
            circle.drawCircle(0, 0, PLAYER_RANGE * 2);

            sprite.add(circle);
            sprite.add(game.make.text(-12, -20, 'ID: ' + player.id.toString(), {font: "bold 18px Arial", fill: "red"}));
            sprite.add(game.make.text(-12, 20, getPlayerObserverText(observers), {font: "bold 18px Arial", fill: "lawngreen"}));
            return sprite;
        }
        function clearUpdateFlags(){
            for(var it = 0; it < players.length; it++){
                players[it].updated = false;
            }
        }
        function updatePlayer(id, x, y, observers){
            var player = getPlayerById(id);
            if(player == undefined) {
                player = {'id': id, 'sprite': undefined, 'updated': true};
                player.sprite = createPlayerSprite(player, observers);
                players.push(player);
            }else{
                player.sprite.position.x = x;
                player.sprite.position.y = y;
                // update observers
                player.sprite.children[player.sprite.length - 1].setText(getPlayerObserverText(observers));
                player.updated = true;
            }
        }
        function parseMessage(msg){
            console.log(msg);
            if(msg == undefined || msg.players == undefined) return undefined;
            clearUpdateFlags();
            for(var it = 0; it < msg.players.length; it++) {
                if(msg.players[it].id == undefined || msg.players[it].x == undefined || msg.players[it].y == undefined || msg.players[it].observers == undefined)
                    return undefined;
                updatePlayer(msg.players[it].id, msg.players[it].x, msg.players[it].y, msg.players[it].observers);
            }

            // remove player if not updated
            for(var it = players.length - 1; it >= 0; it--){
                if(!players[it].updated){
                    players[it].sprite.destroy();
                    players.splice(splice, 1);
                }
            }
        }
        function preload(){
            game.load.image('bg', 'img/dark-green-grass-background.jpg');
        }
        function create(){
            bg = game.add.sprite(0,0, 'bg');
            bg.width = game.width;
            bg.height = game.height;
            initWebsocket();
        }
        $(document).ready(function(){
            game = new Phaser.Game(800, 800, Phaser.AUTO, 'Massive Multiplayer Observer!', {create: create, preload: preload});
        });
        function initWebsocket(){
            var connection = new WebSocket(WEBSOCKET_SERVER_LOCATION);

            connection.onmessage = function(event) {
                parseMessage(JSON.parse(event.data));
            };
            connection.onclose = function(){
                for(it in players){
                    players[it].sprite.destroy();
                }
                players = [];
                setTimeout(function(){initWebsocket()}, 1000);
            };
        }
    </script>
    </body>
</html>