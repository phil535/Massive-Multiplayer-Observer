<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Massive Multiplayer Observer!</title>
        <script src="js/phaser.min.js"></script>
        <script src="js/jquery.min.js"></script>
    </head>
    <body>
    <script type="text/javascript">
        // globals
        var game = undefined;
        var players = [];
        var x;
        var WEBSOCKET_SERVER_LOCATION = 'ws://localhost:8888';
        var PLAYER_RANGE = 50;

        function getPlayerById(id){
            for(var index = 0; index < players.length; ++index){
                if(players[index].id == id)
                    return players[index];
            }
            return undefined;
        }
        function createPlayerSprite(text, x, y){
            if(game == undefined) return undefined;
            var sprite = game.add.group();

            circle = game.add.graphics(10, 10);
            var color = Math.random()*0xFFFFFF;
            circle.beginFill(color, 0.2);
            circle.drawCircle(0, 0, PLAYER_RANGE * 2);
            circle.endFill();
            circle.beginFill(color, 1);
            circle.drawCircle(0, 0, 4);
            circle.endFill();
            circle.lineStyle(1, color);
            circle.drawCircle(0, 0, PLAYER_RANGE * 2);


            sprite.add(circle);
            sprite.add(game.make.text(0, -8, text, {font: "bold 11px Arial", fill: "red"}));

            return sprite;
        }
        function updatePlayer(id, x, y){

            var player = getPlayerById(id);
            if(player == undefined) {
                player = {'id': id, 'sprite': undefined};
                player.sprite = createPlayerSprite('ID: ' + id.toString(), x, y);
                players.push(player);
            }else{
                player.sprite.position.x = x;
                player.sprite.position.y = y;
            }
        }
        function parseMessage(msg){
            if(msg == undefined || msg.players == undefined) return undefined;
            for(var index = 0; index < msg.players.length; ++index) {
                if(msg.players[index].id == undefined || msg.players[index].x == undefined || msg.players[index].y == undefined)
                    return undefined;
                updatePlayer(msg.players[index].id, msg.players[index].x, msg.players[index].y);
            }
        }
        $(document).ready(function(){
            game = new Phaser.Game(800, 800, Phaser.AUTO, 'Massive Multiplayer Observer!', {create: function(){
                initWebsocket();
            }});
        });
        function initWebsocket(){
            var connection = new WebSocket(WEBSOCKET_SERVER_LOCATION);

            connection.onmessage = function(event) {
                parseMessage(JSON.parse(event.data));
            };
            connection.onclose = function(){
                game.world.removeAll();
                setTimeout(function(){initWebsocket()}, 3000);
            };
        }
    </script>
    </body>
</html>